define ["app", "apps/config/storage/localstorage", "entities/playlist"], (Swabcast) ->
  # Generated by CoffeeScript 1.6.3
  Swabcast.module "Entities", (Entities, Swabcast, Backbone, Marionette, $, _) ->
    Entities.PlayerData = Backbone.Model.extend(
      id:0
      urlRoot: "player"
      url:"player"
      currentPosition: 0
      validate: (attrs) ->
        errors = []
        if !attrs.mediaUrl
          errors.push
            message: "Player data must have media url"
        if !attrs.uid
          errors.push
            message:"Player data must have valid uid"
        errors if errors.length
    )
    Entities.configureStorage Entities.PlayerData

    # Entities.PlayerDataStore = Backbone.Collection.extend(
    #   model: Entities.Episode
    #   url: "player"
    # )
    # Entities.configureStorage Entities.PlayerDataStore

    API =
      getPlayerData: ->
        playerSaveData = new Entities.PlayerData(id: 0)
        defer = $.Deferred()
        playerSaveData.fetch
          success: (data) ->
            defer.resolve data

          error: ->
            defer.resolve `undefined`

        promise = defer.promise()
        defer.promise()

      playerReset: ->
        playerSaveData = undefined
        playerSaveData = new Entities.PlayerData(id: 0)

    Swabcast.reqres.setHandler "player:savedata", ->
      API.getPlayerData()

    Swabcast.commands.setHandler "playerdata:remove", ->
      API.playerReset()

    Swabcast.commands.setHandler "playerdata:add", (episodeModel) ->
      API.updateSaveData episodeModel

  return
