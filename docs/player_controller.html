<!DOCTYPE html>

<html>
<head>
  <title>player_controller.coffee</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page">
            
              
              <a class="source" href="SpecRunner.html">
                SpecRunner.coffee
              </a>
            
              
              <a class="source" href="app.html">
                app.coffee
              </a>
            
              
              <a class="source" href="dialog.html">
                dialog.coffee
              </a>
            
              
              <a class="source" href="modal.html">
                modal.coffee
              </a>
            
              
              <a class="source" href="revealoptions.html">
                revealoptions.coffee
              </a>
            
              
              <a class="source" href="localstorage.html">
                localstorage.coffee
              </a>
            
              
              <a class="source" href="episodes_app.html">
                episodes_app.coffee
              </a>
            
              
              <a class="source" href="feed_controller.html">
                feed_controller.coffee
              </a>
            
              
              <a class="source" href="feed_view.html">
                feed_view.coffee
              </a>
            
              
              <a class="source" href="list_controller.html">
                list_controller.coffee
              </a>
            
              
              <a class="source" href="list_view.html">
                list_view.coffee
              </a>
            
              
              <a class="source" href="nav_controller.html">
                nav_controller.coffee
              </a>
            
              
              <a class="source" href="nav_view.html">
                nav_view.coffee
              </a>
            
              
              <a class="source" href="player_controller.html">
                player_controller.coffee
              </a>
            
              
              <a class="source" href="player_view.html">
                player_view.coffee
              </a>
            
              
              <a class="source" href="playlist_controller.html">
                playlist_controller.coffee
              </a>
            
              
              <a class="source" href="playlist_view.html">
                playlist_view.coffee
              </a>
            
              
              <a class="source" href="show_controller.html">
                show_controller.coffee
              </a>
            
              
              <a class="source" href="show_view.html">
                show_view.coffee
              </a>
            
              
              <a class="source" href="list_controller.html">
                list_controller.coffee
              </a>
            
              
              <a class="source" href="list_view.html">
                list_view.coffee
              </a>
            
              
              <a class="source" href="show_controller.html">
                show_controller.coffee
              </a>
            
              
              <a class="source" href="show_view.html">
                show_view.coffee
              </a>
            
              
              <a class="source" href="subscriptions_app.html">
                subscriptions_app.coffee
              </a>
            
              
              <a class="source" href="modal.html">
                modal.coffee
              </a>
            
              
              <a class="source" href="utils.html">
                utils.coffee
              </a>
            
              
              <a class="source" href="view.html">
                view.coffee
              </a>
            
              
              <a class="source" href="views.html">
                views.coffee
              </a>
            
              
              <a class="source" href="feed.html">
                feed.coffee
              </a>
            
              
              <a class="source" href="player.html">
                player.coffee
              </a>
            
              
              <a class="source" href="playlist.html">
                playlist.coffee
              </a>
            
              
              <a class="source" href="subscriptions.html">
                subscriptions.coffee
              </a>
            
              
              <a class="source" href="topics.html">
                topics.coffee
              </a>
            
              
              <a class="source" href="require_main.html">
                require_main.coffee
              </a>
            
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>player_controller.coffee</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              <p>The player controller is responsible for the storing, retrieving and updating the currently playing episode data</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>define [<span class="hljs-string">"app"</span>, <span class="hljs-string">"apps/episodes/player/player_view"</span>], <span class="hljs-function"><span class="hljs-params">(Swabcast, View)</span> -&gt;</span>
  Swabcast.<span class="hljs-built_in">module</span> <span class="hljs-string">"EpisodesApp.Player"</span>, <span class="hljs-function"><span class="hljs-params">(Player, Swabcast, Backbone, Marionette, $, _)</span> -&gt;</span>
    Player.Controller = <span class="hljs-attribute">showControls</span>:<span class="hljs-function"> -&gt;</span>
      <span class="hljs-built_in">require</span> [<span class="hljs-string">"entities/player"</span>],<span class="hljs-function"> -&gt;</span>
        debugging = <span class="hljs-literal">true</span>
        fetchPlayerData = Swabcast.request(<span class="hljs-string">"player:savedata"</span>)
        $.<span class="hljs-keyword">when</span><span class="hljs-function"><span class="hljs-params">(fetchPlayerData)</span>.<span class="hljs-title">done</span> <span class="hljs-params">(playerData)</span> -&gt;</span>
          self = <span class="hljs-keyword">this</span>
          <span class="hljs-keyword">if</span> playerData
          <span class="hljs-keyword">else</span>

          <span class="hljs-property">@initializePlayer</span> =<span class="hljs-function"> -&gt;</span>
            <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> playerData</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>playerData = self.viewData()</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>              playerData = self.defaultPlayerData()

              self.audioPlayer.createAudio() <span class="hljs-comment">#create audio</span>
              self.updateAudio()

          <span class="hljs-property">@updateAudio</span> = <span class="hljs-function"><span class="hljs-params">(sourceUrl)</span> -&gt;</span>
            sourceUrl = sourceUrl <span class="hljs-keyword">or</span> playerData.get(<span class="hljs-string">"mediaUrl"</span>)
            self.audioPlayer.resetAudio()
            <span class="hljs-keyword">if</span> playerData.get(<span class="hljs-string">"currentPosition"</span>) <span class="hljs-keyword">isnt</span> <span class="hljs-number">0</span> <span class="hljs-keyword">and</span> <span class="hljs-keyword">typeof</span> playerData.get(<span class="hljs-string">"currentPosition"</span>) <span class="hljs-keyword">is</span> <span class="hljs-string">"number"</span>
              self.audioPlayer.setAudioSource sourceUrl
              self.audioPlayer.setPosition = playerData.get(<span class="hljs-string">"currentPosition"</span>)
            <span class="hljs-keyword">else</span>
              self.audioPlayer.setAudioSource sourceUrl
              self.audioPlayer.setPosition = <span class="hljs-number">0</span>
            self.audioPlayer.audio.load()

          <span class="hljs-property">@removeCurrentAudio</span> =<span class="hljs-function"> -&gt;</span>
            self.audioPlayer.clearAudio()

          <span class="hljs-property">@newPlayerData</span> = <span class="hljs-function"><span class="hljs-params">(newModelData)</span> -&gt;</span>
            newPlayerData = <span class="hljs-keyword">new</span> Swabcast.Entities.Episode(
              <span class="hljs-attribute">albumArt</span>: newModelData.get(<span class="hljs-string">"albumArt"</span>)
              <span class="hljs-attribute">mediaUrl</span>: newModelData.get(<span class="hljs-string">"mediaUrl"</span>)
              <span class="hljs-attribute">title</span>: newModelData.get(<span class="hljs-string">"episodeTitle"</span>)
              <span class="hljs-attribute">currentPosition</span>: newModelData.get(<span class="hljs-string">"currentPosition"</span>) <span class="hljs-keyword">or</span> <span class="hljs-number">0</span>
            )
            newPlayerData

          <span class="hljs-property">@playNow</span> = <span class="hljs-function"><span class="hljs-params">(newModelData)</span> -&gt;</span>
            self.newPlayerData newModelData
            self.audioPlayer.play()

          <span class="hljs-property">@defaultPlayerData</span> =<span class="hljs-function"> -&gt;</span>
            defaultData = <span class="hljs-keyword">new</span> Swabcast.Entities.Episode(
              <span class="hljs-attribute">albumArt</span>: <span class="hljs-string">"default.jpg"</span>
              <span class="hljs-attribute">mediaUrl</span>: <span class="hljs-string">"./assets/mp3/abranmepaso.mp3"</span>
              <span class="hljs-attribute">title</span>: <span class="hljs-string">"defaultData"</span>
              <span class="hljs-attribute">currentPosition</span>: <span class="hljs-number">0</span>
            )
            defaultData</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>audioplayer object</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          <span class="hljs-property">@audioPlayer</span> =
            <span class="hljs-attribute">createAudio</span>:<span class="hljs-function"> -&gt;</span>
              <span class="hljs-property">@audio</span> = <span class="hljs-keyword">new</span> Audio()
              <span class="hljs-property">@state</span> = <span class="hljs-string">"disabled"</span>

            <span class="hljs-attribute">resetAudio</span>:<span class="hljs-function"> -&gt;</span>
              <span class="hljs-property">@audio</span>.remove()
              <span class="hljs-property">@audio</span> = <span class="hljs-keyword">new</span> Audio()
              <span class="hljs-property">@audio</span>.src = <span class="hljs-string">""</span>

            <span class="hljs-attribute">play</span>:<span class="hljs-function"> -&gt;</span>
              <span class="hljs-property">@audio</span>.play()  <span class="hljs-keyword">if</span> <span class="hljs-property">@state</span> <span class="hljs-keyword">is</span> <span class="hljs-string">"ready"</span>
              <span class="hljs-property">@state</span> = <span class="hljs-string">"playing"</span>

            <span class="hljs-attribute">pause</span>:<span class="hljs-function"> -&gt;</span>
              <span class="hljs-property">@audio</span>.pause()
              <span class="hljs-property">@state</span> = <span class="hljs-string">"ready"</span>

            <span class="hljs-attribute">setState</span>: <span class="hljs-function"><span class="hljs-params">(newState)</span> -&gt;</span>
              <span class="hljs-keyword">return</span>  <span class="hljs-keyword">unless</span> newState
              <span class="hljs-property">@state</span> = newState

            <span class="hljs-attribute">setAudioSource</span>: <span class="hljs-function"><span class="hljs-params">(mediaUrl)</span> -&gt;</span>
              <span class="hljs-property">@audio</span>.src = mediaUrl
              <span class="hljs-keyword">return</span>  <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> mediaUrl <span class="hljs-keyword">or</span> <span class="hljs-keyword">typeof</span> mediaUrl <span class="hljs-keyword">isnt</span> <span class="hljs-string">"string"</span>
              <span class="hljs-property">@state</span> = <span class="hljs-string">"ready"</span>

            <span class="hljs-attribute">clearAudio</span>:<span class="hljs-function"> -&gt;</span>
              <span class="hljs-property">@audio</span>.src = <span class="hljs-string">""</span>
              <span class="hljs-property">@audio</span>.load()
              <span class="hljs-property">@state</span> = <span class="hljs-string">"disabled"</span>

            <span class="hljs-attribute">setPosition</span>: <span class="hljs-function"><span class="hljs-params">(time)</span> -&gt;</span>
              <span class="hljs-property">@audio</span>.currentTime = time  <span class="hljs-keyword">if</span> <span class="hljs-keyword">typeof</span> episodePosition <span class="hljs-keyword">is</span> <span class="hljs-string">"number"</span>

            <span class="hljs-attribute">skipback</span>:<span class="hljs-function"> -&gt;</span>
              <span class="hljs-keyword">if</span> (<span class="hljs-property">@state</span> <span class="hljs-keyword">is</span> <span class="hljs-string">"ready"</span> <span class="hljs-keyword">or</span> <span class="hljs-property">@state</span> <span class="hljs-keyword">is</span> <span class="hljs-string">"playing"</span>) <span class="hljs-keyword">and</span> <span class="hljs-property">@audio</span>.currentTime &gt; <span class="hljs-number">45</span>
                <span class="hljs-property">@audio</span>.pause()
                <span class="hljs-property">@audio</span>.currentTime = (<span class="hljs-property">@audio</span>.currentTime - <span class="hljs-number">45</span>)
                <span class="hljs-property">@audio</span>.play()

            <span class="hljs-attribute">skipahead</span>:<span class="hljs-function"> -&gt;</span>
              self = <span class="hljs-keyword">this</span>
              <span class="hljs-keyword">if</span> (self.state <span class="hljs-keyword">is</span> <span class="hljs-string">"ready"</span> <span class="hljs-keyword">or</span> self.state <span class="hljs-keyword">is</span> <span class="hljs-string">"playing"</span>) <span class="hljs-keyword">and</span> self.audio.currentTime + <span class="hljs-number">45</span> &lt;= self.audio.duration
                self.audio.pause()
                self.audio.currentTime = (self.audio.currentTime + <span class="hljs-number">45</span>)
                self.audio.play()

            <span class="hljs-attribute">currentMediaUrl</span>:<span class="hljs-function"> -&gt;</span>
              <span class="hljs-property">@audio</span>.src

          <span class="hljs-property">@initializePlayer</span>()
          <span class="hljs-property">@playerControls</span> = <span class="hljs-keyword">new</span> View.Player(<span class="hljs-attribute">model</span>: playerData)
          <span class="hljs-property">@playerControls</span>.<span class="hljs-literal">on</span> <span class="hljs-string">"episode:playpause"</span>,<span class="hljs-function"> -&gt;</span>
            <span class="hljs-keyword">switch</span> self.audioPlayer.state
              <span class="hljs-keyword">when</span> <span class="hljs-string">"disabled"</span>, <span class="hljs-string">"ready"</span>
                self.audioPlayer.play()
                $(<span class="hljs-string">"#play-icon"</span>).addClass <span class="hljs-string">"Hidden"</span>
                $(<span class="hljs-string">"#pause-icon"</span>).removeClass <span class="hljs-string">"Hidden"</span>
                self.audioPlayer.setState <span class="hljs-string">"playing"</span>
              <span class="hljs-keyword">when</span> <span class="hljs-string">"playing"</span>
                self.audioPlayer.pause()
                playerData.set <span class="hljs-attribute">currentPosition</span>: self.audioPlayer.audio.currentTime
                $(<span class="hljs-string">"#play-icon"</span>).removeClass <span class="hljs-string">"Hidden"</span>
                $(<span class="hljs-string">"#pause-icon"</span>).addClass <span class="hljs-string">"Hidden"</span>
                self.audioPlayer.setState <span class="hljs-string">"ready"</span>
              <span class="hljs-keyword">else</span>

          <span class="hljs-property">@playerControls</span>.listenTo Player, <span class="hljs-string">"playlist:removed"</span>, <span class="hljs-function"><span class="hljs-params">(deleted)</span> -&gt;</span>
            <span class="hljs-keyword">if</span> deleted.has(<span class="hljs-string">"mediaUrl"</span>) <span class="hljs-keyword">and</span> deleted.get(<span class="hljs-string">"mediaUrl"</span>) <span class="hljs-keyword">is</span> self.audioPlayer.audio.src
              self.audioPlayer.audio.pause()
              self.audioPlayer.audio.src = <span class="hljs-literal">null</span>
            self.updatePlayer()

          <span class="hljs-property">@playerControls</span>.<span class="hljs-literal">on</span> <span class="hljs-string">"episode:skipback"</span>,<span class="hljs-function"> -&gt;</span>
            self.audioPlayer.skipback()

          <span class="hljs-property">@playerControls</span>.<span class="hljs-literal">on</span> <span class="hljs-string">"episode:skipahead"</span>,<span class="hljs-function"> -&gt;</span>
            self.audioPlayer.skipahead()

          <span class="hljs-property">@playerControls</span>.<span class="hljs-literal">on</span> <span class="hljs-string">"episode:previous"</span>,<span class="hljs-function"> -&gt;</span>

          <span class="hljs-property">@playerControls</span>.<span class="hljs-literal">on</span> <span class="hljs-string">"episode:next"</span>,<span class="hljs-function"> -&gt;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>command handlers for responding to playlist triggers</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          Swabcast.commands.setHandler <span class="hljs-string">"player:empty"</span>,<span class="hljs-function"> -&gt;</span>
            self.playerControls.model.destroy()
            self.playerControls.model = self.defaultPlayerData()
            self.updateAudio()
            self.playerControls.render()
            playerData.save()</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>self.defaultSaveData();</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          Swabcast.commands.setHandler <span class="hljs-string">"player:playnow"</span>, <span class="hljs-function"><span class="hljs-params">(episodeModel)</span> -&gt;</span>
            self.playerControls.model.destroy()
            self.newPlayerData episodeModel
            self.updateAudio()
            self.audioPlayer.play()
            self.playerControls.render()
            playerData.save()

          Swabcast.commands.setHandler <span class="hljs-string">"player:setepisode"</span>, <span class="hljs-function"><span class="hljs-params">(episodeModel)</span> -&gt;</span>
            self.playerControls.model.destroy()
            self.playerControls.model = self.newPlayerData(episodeModel)
            self.updateAudio episodeModel.get(<span class="hljs-string">"mediaUrl"</span>)
            self.playerControls.render()
            playerData.save()

          Swabcast.commands.setHandler <span class="hljs-string">"playlist:updatenowplaying"</span>, <span class="hljs-function"><span class="hljs-params">(nextInPlaylist)</span> -&gt;</span>
            self.playerControls.model.destroy()
            self.playerControls.model = self.newPlayerData(nextInPlaylist)
            self.updateAudio nextInPlaylist.get(<span class="hljs-string">"mediaUrl"</span>)
            self.playerControls.render()
            playerData.save()

          <span class="hljs-property">@playerControls</span>.listenTo Player, <span class="hljs-string">"playlist:added"</span>, <span class="hljs-function"><span class="hljs-params">(episodeModel)</span> -&gt;</span>

          Swabcast.playerRegion.show <span class="hljs-property">@playerControls</span>

  Swabcast.EpisodesApp.Player.Controller</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
